name: 'Release'

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Universal (Intel + Apple Silicon) —Å Metal –∏ Accelerate
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
            rust_targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
            cargo_features: 'metal,fast-cpu-accelerate'
            
          # Linux x86_64 —Å Intel MKL –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
          - platform: 'ubuntu-22.04'
            args: ''
            rust_targets: ''
            cargo_features: 'fast-cpu-mkl'
            
          # Windows x86_64 (CPU-only, –±–µ–∑ CUDA)
          - platform: 'windows-latest'
            args: ''
            rust_targets: ''
            cargo_features: ''
            
          # Windows ARM64 (CPU-only)
          - platform: 'windows-latest'
            args: '--target aarch64-pc-windows-msvc'
            rust_targets: 'aarch64-pc-windows-msvc'
            cargo_features: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # macOS: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º build tools –¥–ª—è git ring
      - name: Install build tools (macOS only)
        if: matrix.platform == 'macos-latest'
        run: |
          # Xcode Command Line Tools —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å clang –∏ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
          clang --version
          which perl
          perl --version

      # Linux: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ + Intel MKL
      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            perl
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Intel MKL –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è CPU
          wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB \
            | gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" \
            | sudo tee /etc/apt/sources.list.d/oneAPI.list
          sudo apt-get update
          sudo apt-get install -y intel-oneapi-mkl-devel

      # Windows: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Perl + NASM –¥–ª—è git-–≤–µ—Ä—Å–∏–∏ ring
      - name: Install build tools (Windows only)
        if: matrix.platform == 'windows-latest'
        shell: powershell
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Strawberry Perl
          Write-Host "Installing Strawberry Perl..."
          choco install strawberryperl -y --no-progress
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º NASM
          Write-Host "Installing NASM..."
          choco install nasm -y --no-progress
          
          # –û–±–Ω–æ–≤–ª—è–µ–º PATH –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
          Write-Host "Perl version:"
          perl --version
          Write-Host "NASM version:"
          nasm --version

      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è NASM (–µ—Å–ª–∏ chocolatey –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
      - name: Verify NASM installation (Windows)
        if: matrix.platform == 'windows-latest'
        shell: powershell
        run: |
          try {
            nasm --version
          } catch {
            Write-Host "NASM not found via chocolatey, installing manually..."
            Invoke-WebRequest -Uri "https://www.nasm.us/pub/nasm/releasebuilds/2.16.03/win64/nasm-2.16.03-win64.zip" -OutFile "nasm.zip"
            Expand-Archive -Path "nasm.zip" -DestinationPath "C:\nasm"
            echo "C:\nasm\nasm-2.16.03" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            & "C:\nasm\nasm-2.16.03\nasm.exe" --version
          }

      - name: Install frontend dependencies
        run: npm ci

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'Oxide-Lab v__VERSION__'
          releaseBody: |
            ## üöÄ Oxide-Lab Release
            
            ### CPU-Optimized Builds
            
            **Download for your platform:**
            - üçé **macOS Universal** (Intel + Apple Silicon)
              - ‚ú® Metal GPU acceleration
              - ‚ö° Apple Accelerate framework
              - üéØ Works on all Macs (M1/M2/M3 + Intel)
            
            - üêß **Linux x86_64**
              - ‚ö° Intel MKL optimizations
              - üöÑ Fast CPU inference
            
            - ü™ü **Windows x86_64**
              - üíª CPU-only build
              - ‚úÖ Compatible with all systems
            
            - ü™ü **Windows ARM64**
              - üíª CPU-only build
              - üéØ For ARM-based Windows devices
            
            ---
            
            ### üéÆ NVIDIA GPU Users
            
            **CUDA builds available separately** with:
            - üî• CUDA acceleration
            - ‚ö° cuDNN support
            - üöÄ Flash Attention
            
            Look for assets with `-cuda` suffix for maximum GPU performance.
            
            ---
            
            ### üì¶ Installation
            
            Download the appropriate installer for your platform from the assets below.
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }} ${{ matrix.cargo_features && format('--features {0}', matrix.cargo_features) || '' }}
          updaterJsonPreferNsis: true
