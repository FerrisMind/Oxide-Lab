# Система истории чатов

## Обзор

Система истории чатов в Oxide Lab обеспечивает полноценное сохранение, управление и переключение между различными сессиями чата с LLM-моделями.

## Основные возможности

### 1. Персистентное хранение

- **localStorage**: Все чаты автоматически сохраняются в localStorage браузера
- **Автосохранение**: Сообщения сохраняются в реальном времени при каждом обновлении
- **Восстановление**: При перезапуске приложения все чаты восстанавливаются

### 2. Управление сессиями

- **Множественные чаты**: Поддержка до 50 одновременных сессий
- **Переключение**: Быстрое переключение между чатами с сохранением контекста
- **Автоматическая генерация названий**: Название генерируется из первого сообщения
- **Ручное переименование**: Возможность изменить название любого чата

### 3. Функции экспорта/импорта

- **Экспорт в JSON**: Экспорт любого чата в формате JSON
- **Копирование**: Быстрое копирование данных в буфер обмена
- **Скачивание**: Сохранение чата как файла
- **Импорт**: Восстановление чата из JSON-файла

### 4. UI компоненты

- **Боковая панель истории**: Переключаемая панель со списком чатов
- **Метаинформация**: Отображение даты и количества сообщений
- **Быстрые действия**: Переименование, экспорт, удаление
- **Подтверждение удаления**: Защита от случайного удаления

## Архитектура

### Структура файлов

```
src/lib/
├── stores/
│   ├── chat-history.ts      # Основной store с логикой
│   └── sidebar.ts            # Состояние видимости панели
├── components/
│   └── ChatHistory.svelte    # UI компонент истории
└── chat/
    └── Chat.svelte           # Интеграция с основным чатом
```

### Типы данных

```typescript
type ChatSession = {
  id: string; // Уникальный идентификатор
  title: string; // Название чата
  messages: ChatMessage[]; // Массив сообщений
  createdAt: number; // Timestamp создания
  updatedAt: number; // Timestamp последнего обновления
  modelPath?: string; // Путь к модели (опционально)
  repoId?: string; // ID репозитория (опционально)
};
```

### Store API

#### chatHistory

Основной reactive store для управления историей:

```typescript
// Создание новой сессии
const sessionId = chatHistory.createSession(modelPath?, repoId?);

// Загрузка сессии
chatHistory.loadSession(sessionId);

// Обновление сообщений
chatHistory.updateMessages(messages);

// Добавление сообщения
chatHistory.addMessage({ role: 'user', content: 'Hello' });

// Обновление последнего сообщения (для streaming)
chatHistory.updateLastMessage(content);

// Удаление сессии
chatHistory.deleteSession(sessionId);

// Переименование
chatHistory.renameSession(sessionId, newTitle);

// Экспорт
const json = chatHistory.exportSession(sessionId);

// Импорт
const success = chatHistory.importSession(jsonData);

// Очистка всех сессий
chatHistory.clearAll();
```

#### Derived stores

```typescript
// Текущая активная сессия
import { currentSession } from '$lib/stores/chat-history';

// Отсортированный список сессий (новые сверху)
import { sortedSessions } from '$lib/stores/chat-history';
```

## Использование

### Открытие панели истории

1. На главной странице чата нажмите кнопку со списком в заголовке
2. Панель откроется слева от основного чата

### Создание нового чата

1. Нажмите кнопку "+" в заголовке панели истории
2. Новый чат создастся автоматически и станет активным

### Переключение между чатами

1. Кликните на любой чат в списке
2. Сообщения загрузятся автоматически
3. Вы можете продолжить с того места, где остановились

### Переименование чата

1. Наведите на чат в списке
2. Нажмите иконку редактирования (карандаш)
3. Введите новое название и нажмите Enter

### Экспорт чата

1. Наведите на чат в списке
2. Нажмите иконку экспорта (стрелка вниз)
3. Выберите "Копировать" или "Скачать"

### Импорт чата

1. Нажмите кнопку импорта в заголовке панели
2. Выберите JSON-файл с экспортированным чатом
3. Чат будет добавлен в список с новым ID

### Удаление чата

1. Наведите на чат в списке
2. Нажмите иконку корзины
3. Подтвердите удаление

## Технические детали

### Синхронизация с основным чатом

Система истории интегрирована с основным чат-компонентом через reactive statements:

```typescript
// Синхронизация сообщений с историей
$: {
  if (messages) {
    chatHistory.updateMessages(messages);
  }
}

// Загрузка сообщений при переключении сессии
$: {
  if ($currentSession) {
    messages = $currentSession.messages;
  }
}
```

### Ограничения и оптимизация

- **Максимум сессий**: 50 (настраивается в `MAX_SESSIONS`)
- **Автоматическое удаление**: Старые сессии удаляются при превышении лимита
- **Debounce сохранения**: Для оптимизации производительности

### localStorage

Данные сохраняются под ключом `oxide-lab-chat-history`:

```json
{
  "sessions": [...],
  "currentSessionId": "session-xxx"
}
```

### Обработка ошибок

- Все операции обернуты в try-catch
- При ошибках localStorage данные восстанавливаются из памяти
- Валидация данных при импорте

## Планы развития

### Ближайшие улучшения

- [ ] Поиск по истории чатов
- [ ] Теги и категории для организации
- [ ] Пакетный экспорт/импорт
- [ ] Резервное копирование на сервер
- [ ] Синхронизация между устройствами

### Долгосрочные цели

- [ ] Полнотекстовый поиск по содержимому
- [ ] Автоматическая категоризация с помощью AI
- [ ] Аналитика использования
- [ ] Шаблоны промптов из истории
- [ ] Интеграция с системой закладок

## Отладка

### Просмотр сохраненных данных

```javascript
// В консоли браузера
const data = JSON.parse(localStorage.getItem('oxide-lab-chat-history'));
console.log(data);
```

### Очистка истории

```javascript
localStorage.removeItem('oxide-lab-chat-history');
```

### Проверка состояния

```javascript
// В Svelte DevTools
$chatHistory;
$currentSession;
$sortedSessions;
```

## Лучшие практики

1. **Регулярное резервное копирование**: Экспортируйте важные чаты
2. **Осмысленные названия**: Переименовывайте чаты для лучшей навигации
3. **Удаление старых чатов**: Очищайте неиспользуемые сессии
4. **Мониторинг размера**: Следите за использованием localStorage

## FAQ

**Q: Сколько памяти занимает история?**
A: Зависит от количества и размера сообщений. В среднем 1-5 МБ для 50 чатов.

**Q: Синхронизируются ли чаты между устройствами?**
A: Пока нет, только локальное хранение. Используйте экспорт/импорт.

**Q: Можно ли восстановить удаленный чат?**
A: Нет, удаление необратимо. Рекомендуется экспортировать важные чаты.

**Q: Что происходит при достижении лимита сессий?**
A: Самые старые сессии автоматически удаляются.
