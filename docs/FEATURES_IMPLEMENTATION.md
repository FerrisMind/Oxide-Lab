# Реализация функций: UX переключения моделей, управление памятью, пресеты и метрики

## Обзор

Данный документ описывает полную реализацию четырех ключевых функций приложения:

1. **End-to-end UX переключения моделей**
2. **Управление памятью (VRAM/RAM)**
3. **Система пресетов параметров и расширенные статусные индикаторы**
4. **Визуализация и контроль целевых метрик производительности**

## 1. End-to-end UX переключения моделей

### Компоненты

#### `ModelStatus.svelte`

Компонент отображения статуса модели:

- Индикатор текущего состояния (не загружена/загружается/загружена/ошибка)
- Прогресс-бар загрузки с процентами
- Информация о стадии загрузки (device, file opening, header reading, tokenizer, model init)
- Отображение текущего устройства (CPU/CUDA)
- Обработка ошибок загрузки

#### `ModelActions.svelte`

Компонент управления моделью:

- Настройки загрузки:
  - Длина контекста (512-8192 токенов)
  - Использование GPU (автоматический выбор устройства)
- Загрузка локальных моделей (GGUF, Safetensors)
- Загрузка моделей из HuggingFace Hub
- Выгрузка модели
- Отмена загрузки

#### Страница `/models`

Полноценная страница управления моделями:

- Левая панель: статус модели, мониторинг памяти, действия
- Правая панель: поиск и выбор моделей из HuggingFace
- Адаптивный layout для разных размеров экрана

### Функциональность

```typescript
// События от backend
interface LoadProgressEvent {
  stage: string; // Стадия загрузки
  progress: number; // Прогресс 0-100
  message?: string; // Опциональное сообщение
  done: boolean; // Завершена ли операция
  error?: string; // Опциональная ошибка
}
```

Поддерживаемые стадии:

- `start` - Начало загрузки
- `device` - Выбор устройства
- `open_file` - Открытие файла модели
- `read_header` - Чтение заголовка GGUF/Safetensors
- `tokenizer` - Загрузка токенизатора
- `model_init` - Инициализация модели
- `finalize` - Финализация
- `complete` - Загрузка завершена
- `unload_*` - Стадии выгрузки
- `cancel` - Отменено
- `error` - Ошибка

## 2. Управление памятью (VRAM/RAM)

### Компонент `MemoryMonitor.svelte`

#### Основные возможности

1. **Мониторинг в реальном времени:**
   - Текущее использование памяти
   - Прогресс-бар с цветовой индикацией (зеленый/желтый/красный)
   - Процент использования относительно 8GB

2. **Детали загрузки модели:**
   - Память до загрузки
   - Память после загрузки
   - Дельта (использование моделью)

3. **Пороговые значения:**
   - **Normal**: < 4GB (зеленый)
   - **Warning**: 4-6GB (желтый)
   - **Critical**: > 6GB (красный)

4. **Гарантии очистки:**
   - Принудительная выгрузка модели через UI
   - Освобождение VRAM через CUDA memory pools
   - Очистка токенизатора и связанных ресурсов
   - Rust drop implementation для гарантированного освобождения

#### Информация о VRAM

Компонент предоставляет детальную информацию о работе с VRAM:

- При использовании GPU память загружается в VRAM видеокарты
- Выгрузка модели освобождает как RAM, так и VRAM
- Гарантии очистки через Rust ownership system

## 3. Система пресетов параметров

### Компонент `ParamPresets.svelte`

#### Встроенные пресеты

Соответствуют Rust `SamplingOptions`:

1. **Сбалансированный (Balanced)**
   - Temperature: 0.7
   - Top-k: 20
   - Top-p: 0.9
   - Repeat penalty: 1.1
   - Для большинства задач

2. **Точный (Precise)**
   - Temperature: 0.2
   - Top-k: 10
   - Top-p: 0.8
   - Repeat penalty: 1.2
   - Детерминированный вывод

3. **Креативный (Creative)**
   - Temperature: 0.9
   - Top-k: 50
   - Top-p: 0.95
   - Repeat penalty: 1.05
   - Разнообразный вывод

4. **Детерминированный (Deterministic)**
   - Temperature: 0.0 (argmax)
   - Все sampling выключены
   - Максимально предсказуемый вывод

#### Пользовательские пресеты

- Сохранение текущих параметров как пресет
- Хранение в localStorage
- Удаление пользовательских пресетов
- Краткое отображение параметров (чипы)

#### Интерфейс

```typescript
interface GenerationParams {
  temperature: number;
  temperature_enabled: boolean;
  top_k_enabled: boolean;
  top_k_value: number;
  top_p_enabled: boolean;
  top_p_value: number;
  min_p_enabled: boolean;
  min_p_value: number;
  repeat_penalty_enabled: boolean;
  repeat_penalty_value: number;
  ctx_limit_value: number;
}

interface Preset {
  id: string;
  name: string;
  description: string;
  params: GenerationParams;
  isBuiltin: boolean;
}
```

## 4. Визуализация и контроль метрик производительности

### MVP целевые показатели

```typescript
const MVP_TARGETS = {
  ttft: 3000, // TTFT в миллисекундах (3 сек)
  tokensPerSecond: 10, // Минимум токенов/сек
  modelLoadTime: 30000, // Максимум загрузки модели (30 сек)
  memoryLimit: 8192, // Лимит памяти в MB (8GB)
  startupTime: 5000, // Время запуска (5 сек)
};
```

### Компонент `PerformanceMetrics.svelte`

#### Отслеживаемые метрики

1. **TTFT (Time To First Token)**
   - Время от начала генерации до первого токена
   - Критично для UX отзывчивости
   - Цветовая индикация: зеленый/желтый/красный

2. **Скорость генерации**
   - Токены в секунду
   - Средняя по всем генерациям
   - Цель: > 10 t/s

3. **Время загрузки модели**
   - Общее время с стадиями
   - Размер модели
   - Прирост памяти

4. **Использование памяти**
   - Текущее потребление
   - До/после загрузки
   - Валидация против лимита 8GB

#### Валидация против целей

```typescript
function checkTarget(
  value: number,
  target: number,
  lowerIsBetter: boolean,
): 'good' | 'warning' | 'critical' {
  const ratio = value / target;

  if (lowerIsBetter) {
    if (ratio <= 0.75) return 'good'; // < 75% от цели
    if (ratio <= 1.0) return 'warning'; // 75-100% от цели
    return 'critical'; // > цели
  } else {
    if (ratio >= 1.0) return 'good'; // >= цели
    if (ratio >= 0.75) return 'warning'; // 75-100% от цели
    return 'critical'; // < 75% от цели
  }
}
```

### Компонент `MetricsAlerts.svelte`

#### Система алертов

Автоматическое создание алертов при:

1. **Critical (красные)**
   - TTFT > 4.5 сек (150% от цели)
   - Скорость < 5 t/s (50% от цели)
   - Загрузка > 45 сек (150% от цели)
   - Память > 8GB (100% лимита)

2. **Warning (желтые)**
   - TTFT 3-4.5 сек (100-150% от цели)
   - Скорость 7.5-10 t/s (75-100% от цели)
   - Загрузка 30-45 сек (100-150% от цели)
   - Память 6-8GB (75-100% лимита)

3. **Info (синие)**
   - TTFT < 1.5 сек (отличный результат)
   - Скорость > 20 t/s (отличный результат)

#### Функции алертов

- Автоматическое появление при отклонении от целей
- Отображение текущего и целевого значения
- Временная метка
- Отклонение индивидуальных алертов
- Очистка всех алертов
- Сворачивание/разворачивание панели

### Страница `/performance`

Интеграция всех компонентов:

- Панель алертов вверху
- Левая панель: метрики производительности и мониторинг памяти
- Правая панель: пресеты параметров и информация о метриках
- Адаптивный layout

## Интеграция с backend

### Tauri команды

```rust
// Загрузка модели
#[tauri::command]
pub fn load_model(
    app: tauri::AppHandle,
    state: tauri::State<SharedState<Box<dyn ModelBackend + Send>>>,
    req: LoadRequest,
) -> Result<(), String>

// Выгрузка модели
#[tauri::command]
pub fn unload_model(
    app: tauri::AppHandle,
    state: tauri::State<SharedState<Box<dyn ModelBackend + Send>>>,
) -> Result<(), String>

// Отмена загрузки
#[tauri::command]
pub fn cancel_model_loading() -> Result<(), String>

// Проверка загруженности
#[tauri::command]
pub fn is_model_loaded(...) -> Result<bool, String>

// Метрики производительности
#[tauri::command]
pub async fn get_performance_metrics(...) -> Result<Vec<PerformanceMetric>, String>

#[tauri::command]
pub async fn get_memory_usage(...) -> Result<f64, String>

#[tauri::command]
pub async fn get_startup_metrics(...) -> Result<Option<StartupMetrics>, String>
```

### События

```rust
// Прогресс загрузки
app.emit("load_progress", LoadProgressEvent { ... })

// Метрики загрузки модели
app.emit("model_load_metrics", ModelLoadMetrics { ... })

// Метрики inference
app.emit("inference_metrics", InferenceMetrics { ... })

// Метрики запуска
app.emit("startup_metrics", StartupMetrics { ... })
```

## Навигация

Добавлена новая страница в Sidebar:

- Иконка: `ChartLine` (Phosphor Icons)
- Путь: `/performance`
- Название: "Производительность"

## Используемые технологии

### Frontend

- **Svelte 5**: Runes ($state, $derived, $effect, $props)
- **TypeScript**: Строгая типизация
- **Phosphor Icons**: Иконки UI
- **CSS Custom Properties**: Темизация

### Backend

- **Rust**: Tauri commands
- **Tauri v2**: IPC и события
- **PerformanceMonitor**: Сбор метрик
- **sysinfo**: Мониторинг памяти

## Best Practices

1. **Реактивность Svelte 5**
   - Использование $state для локального состояния
   - $derived для производных значений
   - $effect для побочных эффектов

2. **Доступность (a11y)**
   - role="alert" для критических сообщений
   - role="status" для индикаторов загрузки
   - aria-label для интерактивных элементов
   - Keyboard navigation

3. **Производительность**
   - Ленивая загрузка компонентов
   - Дебаунсинг обновлений
   - Оптимизация реактивности

4. **UX**
   - Немедленная обратная связь
   - Прогресс-индикаторы
   - Четкие сообщения об ошибках
   - Цветовая кодировка статусов

## Тестирование

### Сценарии тестирования

1. **Загрузка модели**
   - Локальная модель GGUF
   - Локальная модель Safetensors
   - Модель из HuggingFace Hub
   - Отмена загрузки
   - Обработка ошибок

2. **Управление памятью**
   - Мониторинг в реальном времени
   - Выгрузка модели
   - Проверка освобождения памяти
   - Пороговые алерты

3. **Пресеты**
   - Применение встроенных пресетов
   - Создание пользовательского пресета
   - Сохранение в localStorage
   - Удаление пресета

4. **Метрики**
   - Сбор метрик TTFT
   - Сбор метрик скорости
   - Валидация против целей
   - Генерация алертов

## Заключение

Реализация полностью покрывает все требования:

✅ **End-to-end UX переключения моделей** - полный flow от выбора до загрузки
✅ **Управление памятью** - мониторинг, контроль, гарантии освобождения
✅ **Пресеты параметров** - встроенные и пользовательские
✅ **Расширенные статусные индикаторы** - детальная информация о состоянии
✅ **Визуализация метрик** - валидация против MVP целей
✅ **Система алертов** - автоматическое оповещение об отклонениях

Все компоненты интегрированы, протестированы и готовы к использованию.
