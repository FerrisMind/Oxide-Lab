Цель: минимизировать архитектурно-зависимый код и упростить добавление новых архитектур (GGUF и float/safetensors) через единые абстракции загрузки, инициализации, токенизации и генерации.

Приоритетные группы: P0 (высокий эффект, низкие риски/затраты) → P1 → P2.

P0 — Быстрые и наиболее эффективные
- Авто-выбор устройства CUDA → Metal → CPU
  - Назначение: автоматически выбирать лучшее доступное устройство, как в примерах Candle.
  - Влияние: более предсказуемая производительность без лишних настроек; единая политика по умолчанию.
  - Затраты: низкие (точечные изменения).
  - Где: `src-tauri/src/core/device.rs` (`select_device`), при необходимости сообщения в `src-tauri/src/api/device.rs`.

- Универсальный загрузчик весов и VarBuilder (Hub/локально)
  - Назначение: вынести в модуль общую логику: поиск `model.safetensors.index.json`, сбор списка шардов/файлов, построение `VarBuilder` с единой политикой `dtype`.
  - Влияние: исключение дублирования, единая точка сопровождения, быстрый путь для новых архитектур.
  - Затраты: низкие-средние.
  - Где: новый модуль `src-tauri/src/core/weights.rs` с функциями: `hub_list_safetensors(...)`, `local_list_safetensors(...)`, `build_varbuilder(...)`; заменить локальный разбор в `api/model_loading/hub_safetensors.rs`.

- Адаптер для float‑LLM из candle_transformers (safetensors)
  - Назначение: позволить использовать модели `ModelForCausalLM` (например, Qwen3 float) через уже существующий трейт `ModelBackend`.
  - Влияние: единая генерация как для GGUF, так и для HF safetensors (без квантовки); снимает барьер для множества архитектур из `candle_transformers`.
  - Затраты: низкие-средние (тонкая обёртка + реализация `AnyModel::from_candle_qwen3`).
  - Где: новый `src-tauri/src/models/common/candle_llm.rs` (реализует `ModelBackend` поверх `ModelForCausalLM`), доработка `src-tauri/src/models/common/model.rs` (реализовать `from_candle_qwen3`).

- Расширение реестра архитектур и детектирование
  - Назначение: распознавать больше архитектур (Llama, Mistral, Mixtral, Gemma, Yi, Falcon, DeepSeek, OLMo и др.) по `config.json`/GGUF metadata.
  - Влияние: централизованное определение архитектуры → единый вход для билдеров моделей.
  - Затраты: низкие.
  - Где: `src-tauri/src/models/registry.rs` — добавить эвристики (по полям типа `model_type`, `architectures`, `general.architecture`, и др.).

P1 — Системные улучшения универсальности
- Введение трейт‑билдера моделей (`ModelBuilder`) и фабрики
  - Назначение: унифицировать создание модели из GGUF и из VarBuilder+config (`from_gguf(...)`, `from_varbuilder(...)`).
  - Влияние: минимизация архитектурного кода до локальных адаптеров; упрощение подключения новых архитектур.
  - Затраты: средние (введение трейт‑слоя и регистрация билдеров по `ArchKind`).
  - Где: новый `src-tauri/src/models/common/builder.rs`; регистрация в `src-tauri/src/models/registry.rs`; адаптеры в `src-tauri/src/models/<arch>.rs`.

- Prompt builder на основе chat template
  - Назначение: единообразно формировать промпт из сообщений и шаблона (`tokenizer.json`/metadata).
  - Влияние: одинаковое поведение чата у разных моделей; снижение копипасты.
  - Затраты: низкие-средние.
  - Где: новый `src-tauri/src/core/prompt.rs`; использование в `src-tauri/src/generate/stream.rs` до токенизации.

- Унификация параметров генерации (SamplingOptions)
  - Назначение: собрать `temperature/top_k/top_p/min_p/seed/repeat_penalty/repeat_last_n` в один тип с дефолтами и единым логированием.
  - Влияние: стабильное поведение и простая передача опций во все режимы генерации.
  - Затраты: низкие.
  - Где: новый `src-tauri/src/core/config.rs` (или `generate/options.rs`); обновить `generate/sampling.rs`, `generate/stream.rs`.

- Централизация политики dtype/precision
  - Назначение: единая политика F16/BF16/F32 (GPU→BF16/F16, CPU→F32) с опциональной переопределяемостью.
  - Влияние: согласованная точность и потребление памяти; меньше расхождений между загрузчиками.
  - Затраты: низкие.
  - Где: новый `src-tauri/src/core/precision.rs`; использовать в `core/weights.rs` и при инициализации моделей.

- Единообразное логирование и ошибки
  - Назначение: унифицировать префиксы (`[load]`, `[infer]`, `[hub]`, `[template]`) и представление ошибок.
  - Влияние: улучшение сопровождения и отладки; понятные трассы для всех архитектур.
  - Затраты: низкие.
  - Где: (опционально) `src-tauri/src/core/error.rs`/`log.rs`; применить в загрузчиках и генерации.

P2 — Повышение надёжности и готовности к росту
- Минимальные smoke‑тесты ключевых компонентов
  - Назначение: проверить `tokenizer_from_gguf_metadata`, извлечение EOS, prompt builder, интерфейс `ModelBackend` (prefill/decode шаги на малых входах).
  - Влияние: снижает регрессии при добавлении архитектур; ускоряет ревью.
  - Затраты: средние (тестовые заглушки/мини‑модели).
  - Где: `src-tauri/tests` или модульные тесты рядом с кодом.

- Общие препроцессоры/постпроцессоры для мультимодальных моделей
  - Назначение: заложить основу для CV/Audio (нормализация, ресайз, mel‑спектрограммы) по образцу `candle_examples`.
  - Влияние: готовность к будущим архитектурам (CLIP, Whisper и т.п.).
  - Затраты: средние; опционально.
  - Где: `src-tauri/src/core/vision.rs`, `src-tauri/src/core/audio.rs` (по необходимости).

- Расширение интерфейса `ModelBackend` при необходимости
  - Назначение: явно выразить поддержку kv‑cache/позиций, спец‑токенов, ограничений контекста.
  - Влияние: менее хрупкая интеграция разных реализаций; упрощение оптимизаций.
  - Затраты: низкие‑средние (по мере появления потребности).
  - Где: `src-tauri/src/models/common/model.rs` (расширение трейта и адаптеров).

Рекомендуемый порядок внедрения (по убыванию приоритета)
1) P0: авто‑device; модуль `core/weights.rs`; адаптер float‑LLM; расширение детекта архитектур.
2) P1: `ModelBuilder`+фабрика; prompt builder; `SamplingOptions`; `precision`‑политика; единое логирование.
3) P2: smoke‑тесты; мультимодальные утилиты; эволюция `ModelBackend` при необходимости.

Ожидаемый результат
- Добавление новой архитектуры сводится к: (а) дописать детект в `registry`, (б) реализовать адаптер/билдер в `models/<arch>.rs` (GGUF и/или VarBuilder), (в) при необходимости настроить prompt‑builder. Остальное (загрузка весов, политика dtype, устройство, генерация, токенизация, логи) — универсально и не меняется.

