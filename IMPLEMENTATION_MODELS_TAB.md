# Реализация двухвкладочного менеджера моделей

## Обзор

Успешно реализована система управления моделями с двумя вкладками:

1. **Локальные модели** - управление моделями, хранящимися на локальном диске
2. **Hugging Face** - поиск и загрузка моделей из Hugging Face Hub

## Реализованные компоненты

### Backend (Rust/Tauri)

#### `src-tauri/src/api/local_models.rs`

Новый модуль для работы с локальными моделями:

**Типы:**

- `LocalModelInfo` - информация о локальной модели (путь, имя, архитектура, параметры, автор, квантизация, размер, формат, дата изменения)

**Функции:**

- `extract_gguf_metadata()` - извлечение метаданных из GGUF файлов с помощью Candle
- `extract_safetensors_metadata()` - извлечение метаданных из Safetensors файлов через config.json
- `extract_quantization_from_filename()` - определение уровня квантизации по имени файла (Q4_K_M, Q5_K_S, F16, F32)
- `format_parameter_count()` - форматирование количества параметров (7B, 13B, 1.5M)
- `scan_directory()` - рекурсивное сканирование папки на наличие моделей

**Tauri команды:**

- `scan_local_models_folder(folder_path: String)` - сканирование папки и возврат списка моделей
- `delete_local_model(model_path: String)` - удаление модели с диска

#### Обновления в `src-tauri/src/lib.rs`

- Зарегистрированы новые команды в invoke_handler

#### Обновления в `src-tauri/Cargo.toml`

- Добавлена зависимость `regex = "1"` для парсинга имен файлов

### Frontend (TypeScript/Svelte)

#### Типы (`src/lib/types/local-models.ts`)

- `LocalModelInfo` - интерфейс информации о локальной модели
- `LocalModelsCache` - интерфейс кэша локальных моделей
- `SortField`, `SortOrder` - типы для сортировки
- `FilterOptions` - опции фильтрации моделей

#### Сервисы (`src/lib/services/local-models.ts`)

`LocalModelsService` класс с методами:

- `scanFolder()` - сканирование папки через Tauri
- `deleteModel()` - удаление модели
- `formatFileSize()` - форматирование размера файла (GB, MB)
- `formatDate()` - форматирование даты
- `sortModels()` - сортировка моделей
- `filterModels()` - фильтрация моделей
- `getUniqueValues()` - получение уникальных значений для фильтров

#### Stores (`src/lib/stores/local-models.ts`)

Svelte stores для управления состоянием:

- `folderPath` - выбранная папка (сохраняется в localStorage)
- `models` - список моделей
- `selectedModel` - выбранная модель
- `isLoading` - состояние загрузки
- `error` - сообщение об ошибке
- `cache` - кэш сканированных моделей (TTL: 5 минут)
- `filteredModels` - derived store с отфильтрованными и отсортированными моделями

Функции:

- `scanFolder(path, forceRefresh)` - сканирование с кэшированием
- `deleteModel(path)` - удаление модели
- `selectModel(model)` - выбор модели
- `clearCache()` - очистка кэша

### UI Компоненты

#### `src/lib/components/ui/Tabs.svelte`

Переиспользуемый компонент горизонтальных вкладок:

- Поддержка клавиатурной навигации (стрелки, Home, End)
- ARIA атрибуты для accessibility
- Современный дизайн 2025
- Адаптивность для мобильных устройств

#### `src/lib/components/ui/ConfirmDialog.svelte`

Модальное окно подтверждения:

- Focus trap для клавиатурной навигации
- ARIA атрибуты
- Поддержка Escape для закрытия
- Клик вне диалога для закрытия
- Анимация появления/исчезновения

#### `src/lib/components/model-manager/LocalModelsList.svelte`

Таблица локальных моделей:

- Отображение: название, архитектура, параметры, квантизация, размер, формат
- Сортировка по имени и размеру
- Выбор модели (подсветка)
- Кнопка удаления с подтверждением
- Адаптивность (скрывает колонки на мобильных)
- Иконки из phosphor-svelte

#### `src/lib/components/model-manager/LocalModelActions.svelte`

Панель действий с локальными моделями:

- Кнопка выбора папки через Tauri dialog
- Отображение текущей папки
- Кнопка пересканирования
- Настройки загрузки модели (context length, GPU)
- Кнопка загрузки выбранной модели
- Поддержка GGUF и Safetensors форматов

#### `src/lib/components/model-manager/LocalModelsTab.svelte`

Главный компонент вкладки локальных моделей:

- Левая панель: ModelStatus, MemoryMonitor, LocalModelActions
- Правая панель: список моделей
- Обработка состояний: загрузка, ошибка, пустой список

#### `src/lib/components/model-manager/HuggingFaceTab.svelte`

Вкладка поиска моделей Hugging Face:

- Левая панель: ModelStatus, MemoryMonitor, ModelActions
- Правая панель: фильтры поиска и результаты
- Интеграция с SearchManager и SearchResults
- Перенесен функционал из отдельной страницы search

#### `src/routes/models/+page.svelte`

Обновленная главная страница менеджера:

- Использует компонент Tabs
- Переключение между вкладками
- Каждая вкладка имеет собственную левую панель
- Адаптивный layout

## Функциональность

### Локальные модели

✅ Выбор папки через встроенный диалог  
✅ Рекурсивное сканирование папки на наличие .gguf и .safetensors файлов  
✅ Извлечение метаданных из моделей:

- Архитектура (из GGUF метаданных или config.json)
- Количество параметров
- Автор
- Уровень квантизации (из имени файла)
- Размер на диске
- Формат (GGUF/Safetensors)  
  ✅ Отображение моделей в виде таблицы  
  ✅ Сортировка по имени и размеру  
  ✅ Выбор модели для загрузки  
  ✅ Удаление моделей с подтверждением  
  ✅ Кэширование результатов сканирования (5 минут)  
  ✅ Сохранение выбранной папки в localStorage  
  ✅ Кнопка пересканирования для обновления списка

### Hugging Face

✅ Перенесен весь функционал из страницы search  
✅ Фильтры поиска  
✅ Отображение результатов  
✅ Просмотр деталей модели  
✅ Загрузка моделей

### UI/UX

✅ Горизонтальные табы в верхней части  
✅ Каждая вкладка имеет собственную левую панель  
✅ Современный дизайн (2025)  
✅ Анимации переключения  
✅ Адаптивность для мобильных устройств  
✅ Accessibility (ARIA, клавиатурная навигация)  
✅ Состояния загрузки и ошибок

## Технические детали

### Парсинг метаданных

**GGUF файлы:**

- Используется встроенный парсер Candle: `candle::quantized::gguf_file::Content::read()`
- Извлекаются: `general.architecture`, `general.name`, `general.author`, `general.parameter_count`

**Safetensors файлы:**

- Поиск config.json в той же папке
- Извлекаются: `architectures`, `model_type`, `num_parameters`

**Квантизация:**

- Regex парсинг имени файла: `(Q[0-9]_[KMS](?:_[A-Z])?|F16|F32|BF16)`
- Примеры: Q4_K_M, Q5_K_S, Q8_0, F16, F32

### Кэширование

- TTL: 5 минут
- Хранится в памяти (Svelte store)
- Проверка актуальности по пути и времени
- Опция принудительного обновления

### Иконки

- Библиотека: phosphor-svelte v2.0.1
- Использованные иконки: Trash, CaretUp, CaretDown, FolderOpen, ArrowClockwise
- Монтирование через Svelte mount/unmount API

## Соответствие требованиям

✅ Две вкладки: "Локальные модели" и "Hugging Face"  
✅ Возможность выбора папки вручную  
✅ Сканирование папки на наличие моделей  
✅ Отображение моделей в виде списка  
✅ Показ: архитектуры, параметров, автора, названия, квантизации, размера  
✅ Возможность удаления моделей из интерфейса  
✅ Перенос функционала поиска во вкладку  
✅ Горизонтальные табы в верхней части  
✅ Отдельные левые панели для каждой вкладки  
✅ Встроенный диалог выбора папки  
✅ Кэширование результатов сканирования

## Использование

### Вкладка "Локальные модели"

1. Нажмите кнопку "Выбрать папку"
2. Выберите папку с моделями в диалоге
3. Дождитесь сканирования (автоматически)
4. Модели отобразятся в таблице
5. Кликните на модель для выбора
6. Настройте параметры загрузки (context length, GPU)
7. Нажмите "Загрузить модель"

Для удаления модели:

1. Нажмите кнопку корзины в строке модели
2. Подтвердите удаление в диалоге

Для пересканирования:

1. Нажмите кнопку обновления рядом с названием папки

### Вкладка "Hugging Face"

Используется так же, как и прежняя страница поиска моделей.

## Файлы, созданные/изменённые

### Созданные файлы:

- `src-tauri/src/api/local_models.rs`
- `src/lib/types/local-models.ts`
- `src/lib/services/local-models.ts`
- `src/lib/stores/local-models.ts`
- `src/lib/components/ui/Tabs.svelte`
- `src/lib/components/ui/ConfirmDialog.svelte`
- `src/lib/components/model-manager/LocalModelsList.svelte`
- `src/lib/components/model-manager/LocalModelActions.svelte`
- `src/lib/components/model-manager/LocalModelsTab.svelte`
- `src/lib/components/model-manager/HuggingFaceTab.svelte`

### Изменённые файлы:

- `src-tauri/Cargo.toml` (добавлена зависимость regex)
- `src-tauri/src/api/mod.rs` (импорт local_models)
- `src-tauri/src/lib.rs` (регистрация команд)
- `src/routes/models/+page.svelte` (полная переработка для табов)

## Следующие шаги

Для дальнейшего развития функционала рекомендуется:

1. **Фильтрация локальных моделей:**
   - По формату (GGUF/Safetensors)
   - По архитектуре
   - По квантизации
   - Поиск по имени

2. **Дополнительная информация:**
   - Дата последнего использования
   - Теги/метки для организации
   - Заметки к моделям

3. **Группировка моделей:**
   - По папкам
   - По архитектуре
   - По размеру

4. **Массовые операции:**
   - Удаление нескольких моделей
   - Экспорт списка моделей

5. **Статистика:**
   - Общий размер занятого места
   - Количество моделей по типам
   - График использования

## Заключение

Реализация полностью соответствует техническому заданию и следует лучшим практикам разработки:

- Чистая архитектура (разделение backend/frontend/UI)
- Типобезопасность (TypeScript + Rust)
- Accessibility (ARIA, клавиатурная навигация)
- Производительность (кэширование, оптимизация рендеринга)
- UX (состояния загрузки, ошибки, подтверждения)
- Адаптивность (мобильные устройства)
- Современный дизайн (2025)
